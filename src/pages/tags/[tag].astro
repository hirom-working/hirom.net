---
import type { GetStaticPaths } from 'astro'
import { getCollection } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'
import PostList from '@/components/widgets/PostList.astro'
import { themeConfig } from '@/config'

export const getStaticPaths = (async () => {
  const posts = await getCollection('posts')
  const allTags = new Set<string>()
  posts.forEach(post => {
    post.data.tags?.forEach(tag => allTags.add(tag.toLowerCase()))
  })

  return Array.from(allTags).map(tag => ({
    params: { tag: tag.replace(/\s+/g, '-') }, // Ensure slug is hyphenated
    props: { tag: tag } // Pass original tag for display
  }))
}) satisfies GetStaticPaths

interface Props {
  tag: string
}

const { tag } = Astro.props

const allPosts = await getCollection('posts')
const filteredPosts = allPosts.filter(post => 
  post.data.tags?.map(t => t.toLowerCase()).includes(tag.toLowerCase())
).sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())

const pageTitle = `#${tag} の記事一覧`
---

<BaseLayout title={`${pageTitle} · ${themeConfig.site.title}`}>
  <main>
    <div class="prose">
      <h1>{pageTitle}</h1>
      <PostList posts={filteredPosts} />
    </div>
  </main>
</BaseLayout>

<style>
  .prose {
    padding: 1rem;
  }
</style>